<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <link rel="manifest" href="manifest.json">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/dayjs"></script>
  <title>Чекин-чекаут</title>
  <style>
    html, body, .time-tracking {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: sans-serif;
      overflow: hidden;
    }

    .invisible {
      display: none !important;
    }

    .time-tracking {
      margin: 0 auto;
      font-size: 4vw;
      display: flex;
      height: 100%;
      flex-direction: column;
    }

    .month-header {
      height: 17vw;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-around;
      border-bottom: 1px solid #ebebeb;
      background: #0095de;
      width: 100%;
      flex: 0 0 auto;
      color: white;
      font-weight: 600;
    }

    .month-hours {
      width: 70%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      font-size: 4vw;
    }

    .month-name {
      width: 30%;
      text-align: center;
      font-size: 5vw;
    }

    .all-days {
      padding: 0 3vw;
      overflow-y: scroll;
      flex: 1 1 auto;
      position: relative;
    }

    .working-day {
      display: flex;
      flex-direction: row;
      padding: 2vw;
      height: 10vw;
      background: white;
      box-shadow: 0 1px 5px rgba(32, 33, 36, 0.28);
      border-radius: 3vw;
      margin: 4vw 0;
    }

    .lunch {
      background: #feffe1;
    }

    .day-title {
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      align-items: center;
      width: 12%;
    }

    .day-working-hours {
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      align-items: center;
      width: 75%;
    }

    .time {
      width: 50%;
      margin: 0 4vw;
    }

    .time > * {
      font-size: inherit;
      font-family: inherit;
      outline: none;
      border: none;
      border-bottom: 1px dashed #0095de;
      color: #0095de;
      background: inherit;
      width: 100%;
      line-height: 1.5;
      text-align: center;
    }

    .change-time {
      outline: none;
      font-size: inherit;
      font-family: inherit;
    }

    .total-time {
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
</body>
<script>
  (function() {
  
    function render(dayList) {
      document.body.innerHTML = `
      <div class='time-tracking'>
        ${renderHeader(dayList)}
        <div class='all-days'>
          ${dayList.map(day => renderDay(day)).join('\n')}
        </div>
      </div>
      `
    }

    function renderHeader(dayList) {
      return `
      <div class='month-header'>
        <div class='month-name'>Ноябрь</div>
        <div class='month-hours'>
          <div class='worked-hours'>Всего: ${formatMinutes(totalMinutes(dayList))}</div>
          <div class='overtime'>${isOvertime(dayList) 
              ? 'Переработка: ' + formatMinutes(diffFromNormInMinutes(dayList))
              : 'Недоработка: ' + formatMinutes(-diffFromNormInMinutes(dayList)) }
          </div>
        </div>
      </div>
      `
    }

    function renderDay(day) {
      const lunch = isLunch(day), started = isStarted(day), ended = isEnded(day)
      return `
      <div class='working-day ${lunch ? 'lunch' : ''}'>
        <div class='day-title'>
          <div class='day-number'>${dayNumber(day)}</div>
          <div class='day-name'>${dayName(day)}</div>
        </div>
        <div class='day-working-hours'>
          <div class='time'>
            <div class='${started ? 'invisible' : ''}' data-id='${day.id}' data-action='checkin'>Чекин</div>
            <input class='${started ? '' : 'invisible'}' type='time' data-id='${day.id}' data-action='startTime' value='${startTimeToStr(day)}'/>
          </div>
          <div class='time ${started ? '' : 'invisible'}'>
            <div class='${ended ? 'invisible' : ''}' data-id='${day.id}' data-action='checkout'>${lunch ? 'Вернулся': 'Чекаут'}</div>
            <input type='time' class='${ended ? '' : 'invisible'}' data-id='${day.id}' data-action='endTime' value='${endTimeToStr(day)}'/>
          </div> 
          <div class='time ${(lunch && !started) ? '' : 'invisible'}'>
            <div data-id='${day.id}' data-action='lunch'>На обед</div>
          </div>
        </div>
        <div class='total-time'>${formatMinutes(timeDiffInMinutes(day))}</div>
      </div>
      `
    }

    function dayNumber(day) { return dayjs(day.date).date().toString() }

    function isStarted(day) { return Boolean(startTime(day)) }

    function isEnded(day) { return Boolean(endTime(day)) }

    function startTime(day) { return timeToDate(day.startTime, dayjs(day.date)) }

    function endTime(day) { return timeToDate(day.endTime, dayjs(day.date)) }

    function timeToDate(aString, date) {
      if (!aString) { return }
      return date.set('h', aString.split(':')[0]).set('m', aString.split(':')[1])
    }
    
    function dayById(dayList, id) { return dayList.find(d => d.id === Number(id)) }

    function addDay(dayList, newDay) { return [newDay, ...dayList] }

    function replaceDay(dayList, oldDay, newDay) {
      return dayList.reduce((replaced, day) => [...replaced, isEqual(day, oldDay) ? newDay : day], [])
    }

    function isEqual(day1, day2) { return day1.id === day2.id }

    function isLunch(day) { return day.type === 'lunch' }

    function markAsLunch(day) { return Object.assign({}, day, {type: 'lunch'}) }

    function markAsOffice(day) { return Object.assign({}, day, {type: 'office'}) }

    function startTimeToNow(day) { return changeStartTime(day, timeToStr(today())) }

    function changeStartTime(day, startTime) { return Object.assign({}, day, {startTime}) }

    function endTimeToNow(day) { return changeEndTime(day, timeToStr(today())) }

    function changeEndTime(day, endTime) { return Object.assign({}, day, {endTime}) }

    function dayName(day) { return ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'][dayjs(day.date).day()] }

    function startTimeToStr(day) { return timeToStr(startTime(day)) }

    function endTimeToStr(day) { return timeToStr(endTime(day)) }

    function timeToStr(aTime) { return aTime ? aTime.format('HH:mm') : '' }

    function formatMinutes(aNumber) {
      const hours = Math.floor(aNumber / 60)
      const minutes = Math.max(aNumber - hours * 60, 0)
      return `${hours < 10 ? '0' + hours : hours}:${minutes < 10 ? '0' + minutes : minutes}`
    }

    function sumMinutes(dayList) { return dayList.reduce((sum, d) => sum + timeDiffInMinutes(d), 0) }

    function timeDiffInMinutes(day) {
      return Math.max(!isStarted(day) ? 0 : (endTime(day) || today()).diff(startTime(day), 'minute'), 0)
    }

    function isOvertime(dayList) { return diffFromNormInMinutes(dayList) >= 0 }

    function diffFromNormInMinutes(dayList) { return totalMinutes(dayList) - size(uniqueDates(dayList)) * dayNormInMinutes() }

    function dayNormInMinutes() { return 9 * 60 }

    function totalMinutes(dayList) {
      return uniqueDates(dayList).reduce((sum, d) =>
        sum + totalOfficeMinutesForDate(dayList, d.date) + totalLunchMinutesForDate(dayList, d.date), 0)
    }

    function uniqueDates(dayList) {
      return dayList.reduce((unique, d) => hasSameDateAsDay(unique, d) ? unique : [...unique, d], [])
    }

    function hasSameDateAsDay(dayList, day) { return size(dayList.filter(d => d.date === day.date)) > 0 }

    function isEmpty(dayList) { return size(dayList) === 0 }

    function size(dayList) { return dayList.length }

    function last(dayList) { return dayList[0] || emptyDayWithTypeAndId('office', 1) }

    function emptyDay(dayList) {
      return emptyDayWithType(dayList, isLunchAvailable(dayList) ? 'lunch' : 'office')
    }

    function emptyDayWithType(dayList, type) { return emptyDayWithTypeAndId(type, last(dayList).id + 1) }

    function emptyDayWithTypeAndId(type, id) {
      return {id: id, type, date: dateToStr(today()), startTime: '', endTime: ''}
    }

    function isLunchAvailable(dayList) {
      return !isEmpty(dayList) && isToday(last(dayList)) && totalLunchMinutesForDate(dayList, dateToStr(today())) < 60
    }

    function totalLunchMinutesForDate(dayList, date) {
      return Math.min(60, sumMinutes(dayList.filter(d => d.date === date).filter(isLunch)))
    }

    function totalOfficeMinutesForDate(dayList, date) {
      return sumMinutes(dayList.filter(d => d.date === date).filter(d => !isLunch(d)))
    }

    function isToday(day) { return day.date === dateToStr(today()) }

    function today() { return dayjs() }

    function dateToStr(date) { return date.format('YYYY-MM-DD') }

    function allDays() { 
      const days = JSON.parse(localStorage.getItem('days')) || []
      if (isEmpty(days) || isEnded(last(days))) { return [emptyDay(days), ...days] }
      return days
    }

    function allDaysIs(dayList) {
      localStorage.setItem('days', JSON.stringify(dayList.filter(isValidDay)))
      window.dispatchEvent(new Event('storage'))
    }
    
    function isValidDay(day) { return day.date && startTime(day) }

    function react(reactionMap) {
      return event => {
        const reaction = reactionMap[event.target.dataset.action]
        if (!reaction) { return }
        const days = allDays()
        reaction(event, days, dayById(days, event.target.dataset.id))
      }
    }

    window.addEventListener('storage', () => render(allDays()))
    setInterval(() => render(allDays()), 60 * 1000)
    render(allDays())
    
    document.body.addEventListener('click', react({
        checkin: (_, days, day) => allDaysIs(addDay(days, markAsOffice(startTimeToNow(day)))),
        checkout: (_, days, day) => {
          const newDays = replaceDay(days, day, endTimeToNow(day))
          if (isLunch(day)) { allDaysIs(addDay(newDays, startTimeToNow(emptyDayWithType(newDays, 'office')))) }
          else { allDaysIs(newDays) }
        },
        lunch: (_, days, day) => allDaysIs(addDay(days, markAsLunch(startTimeToNow(day)))),
      }), true)

      document.body.addEventListener('blur', react({
        startTime: ({target}, days, day) => allDaysIs(replaceDay(days, day, changeStartTime(day, target.value))),
        endTime: ({target}, days, day) => allDaysIs(replaceDay(days, day, changeEndTime(day, target.value))),
      }), true)
  })()
</script>
</html>
